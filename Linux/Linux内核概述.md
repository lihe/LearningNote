## 什么是内核

内核是操作系统的关键组件。 它借助进程间通信和系统调用，在硬件级别上充当应用程序和数据处理之间的桥梁。

每当将操作系统加载到内存中时，首先，将加载内核并将其保留在那里，直到操作系统关闭。 内核负责处理低级任务，例如任务管理，内存管理，风险管理等。

## Linux内核

内核是任何基于Linux的操作系统的核心组件。 它代表了台式机和服务器的Linux发行版的核心方面。 

它具有整体架构，并且操作系统完全在内核空间中运行。 整体内核不仅包围中央处理器，IPC和内存，而且具有系统服务器调用，设备驱动程序和文件系统管理。 

==Linux内核充当设备软件和硬件之间的一层。==

内核可以是单片，微内核或混合内核（例如OS X和Windows 7）。 Linux内核是类似于UNIX系统的单片计算机操作系统内核。 

Linux操作系统系列（通常称为Linux发行版）基于此内核。与微内核不同，单块内核不仅包含中央处理单元，内存和IPC，还具有设备驱动程序，系统服务器调用和文件系统管理。他们最擅长与硬件通信并同时执行多项任务。由于这个原因，此处的过程反应速度很快。

## Linux体系结构

Linux从CPU的角度出发，为了保护内核的安全，把系统分成了2部分；用户空间和内核空间是程序执行的两种不同状态，我们可以通过“系统调用”和“硬件中断“来完成用户空间到内核空间的转移

### 内核空间

Linux系统对自身进行了划分，一部分核心软件独立于普通应用程序，运行在较高的特权级别上，它们驻留在被保护的内存空间上，拥有访问硬件设备的所有权限，Linux将此称为内核空间。

### 用户空间

用户空间或用户域是在操作系统内核环境之外运行的代码，用户空间定义为操作系统用来与内核连接的各种应用程序或程序或库。

用户的应用程序是在用户空间中执行的，它们可以通过内核系统调用访问计算机可用资源的一部分。 通过使用内核提供的核心服务，可以创建用户级别的应用程序，例如游戏或办公软件。

## Linux内核的任务

1. 从技术层面讲，内核是硬件与软件之间的一个中间层。作用是将应用层的请求传递给硬件，并充当底层驱动程序，对系统中的各种设备和组件进行寻址。
2. 从应用程序的层面讲，应用程序与硬件没有联系，只与内核有联系，内核是应用程序知道的层次中的最底层。在实际工作中内核抽象了相关细节。
3. 内核是一个资源管理程序。负责将可用的共享资源(CPU时间、磁盘空间、网络连接等)分配得到各个系统进程。
4. 内核就像一个库，提供了一组面向系统的命令。系统调用对于应用程序来说，就像调用普通函数一样。

## 内核源码结构

![image-20210201160634004](https://cdn.jsdelivr.net/gh/lihe/Pic/img/20210201160634.png)

- arch 特定体系结构的代码
- block 块设备I/O层
- crypo 加密API
- Documentation 内核源码文档
- drivers 设备驱动程序
- firmware 使用某些驱动程序而需要的设备固件
- fs VFS和各种文件系统
- include 内核头文件
- init 内核引导和初始化
- ipc 进程间通信代码
- kernel 像调度程序这样的核心子系统
- lib 实现需要在内核中使用的库函数
- mm 内存管理子系统和VM
- net 网络子系统
- samples 示例，示范代码
- scripts 编译内核所用的脚本
- security Linux 安全模块
- sound 语音子系统
- usr 早期用户空间代码（所谓的initramfs）
- tools 在Linux开发中有用的工具
- virt 虚拟化基础结构

## Linux内核与其他Unix内核差异

- Linux支持内核模块的动态加载
- Linux内核是抢占式的
- Linux具有对称的多处理器支持
- Linux具有开放软件特性，因此是免费的
- Linux忽略了内核开发人员称为“设计不良”的某些标准Unix功能
- Linux提供了带有设备类，可热插拔事件和用户空间设备文件系统的面向对象的设备模型
- Linux内核无法区分线程和正常进程

## Linux内核体系结构

内核仅仅是资源管理器。 被管理的资源可以是进程，内存或硬件设备。 

它管理和仲裁多个竞争用户之间对资源的访问。 Linux内核存在于用户空间下方的内核空间中，该空间是执行用户应用程序的位置。 

Linux内核的体系结构主要包括：系统调用接口，进程管理，虚拟文件系统，内存管理，体系结构和设备驱动程序，这些称为Linux内核的主要子系统。

### 系统调用接口（System call interface）

简单来说，系统调用就是用户程序和硬件设备之间的桥梁。用户程序在需要的时候，通过系统调用来使用硬件设备。系统调用是一种编程过程，用于承担从用户空间到内核的函数调用，其中程序从操作系统内核请求服务。 该接口可能取决于体系结构。它包括各种硬件服务，例如与硬件设备连接以及在内核的各个组成部分之间创建通信接口。 系统调用在操作系统和进程之间创建有效的接口。

### 进程管理 （Process management）

执行进程，内核负责创建和删除不同的进程，并监视它们与外部世界的连接。例如输入和输出。 它通过信号，进程间通信原语或管道来处理不同方法之间的通信。 除了所有这些之外，它还有一个调度程序，用于控制共享CPU的进程。

### 内存管理（Memory management）

内存是操作系统的重要组成部分，内存在所谓的页面中进行管理以提高效率。 Linux包括管理可用内存的方法以及用于物理和虚拟映射的硬件机制，还提供交换空间。内存管理不仅仅管理4KB缓冲区。 Linux还提供了4kb缓冲区以外的抽象（称为slab分配器）。 Slab分配器使用4kb缓冲区作为基础，然后通过监视诸如页面已满，为空和部分使用之类的内容从内部分配结构。 这使方案可以动态增长，并可以支持系统的更重要需求。

### 虚拟文件系统（Virtual file system）

虚拟文件系统（VFS）是内核的重要组成部分，它为文件系统提供了标准的接口抽象。 它提供了系统调用接口和内核支持的文件系统之间的切换层。 VFS在内核支持的文件系统和SCI（系统调用接口）之间创建一个交换层。除了上述内容之外，Linux还支持各种类型的文件系统，这些文件系统需要以不同的方式组织数据以物理格式存储。 例如，可以使用常用的FAT文件系统，Linux标准ext3文件系统或其他几种格式来格式化磁盘。

### 设备驱动（Device drivers）

内核的大部分源代码存储在设备驱动程序中，这使特定的硬件设备可用。 Linux提供了一个驱动程序子目录，该子目录又分为支持的各种设备，例如I2蓝牙，串行等。

### 依赖体系结构的代码（Architecture-dependent code）

即使大多数Linux在其独立体系结构上运行，也应考虑某些因素以提高体系结构效率和正常运行。 Linux有许多子目录，每个体系结构子目录有许多其他子目录。 而且，这些子目录专注于内核的特定任务，例如内存管理，引导，内核等。